{% extends "base.html" %}
{% load static %}
{% block title %}Root Concept{% endblock title %}
{% block stylesheets %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link rel="stylesheet" href="{% static 'styles/get_domain.css' %}"/>
{% endblock stylesheets %}
{% block content %}
    <h1>Enter the root concept</h1>
    <form id="miFormulario" method="post">
        {% csrf_token %}
        <div class="domain-container">
            <select class="mb-3 dominio" name="dominio"></select>
            <label>Filter</label>
            <select class="filter" name="filter" id="filter">
                <option value="0">URI (_)</option>
                <option value="1">Tag ( )</option>
            </select>
        </div>
        <select style="margin-top: 20px"
                class="subdominios"
                name="subdominios"
                multiple="multiple"></select>
        <input type="hidden" name="contador" id="contador" value="0">
        <input type="hidden" name="valores_seleccionados" id="valores_seleccionados">
        <div>
            <input style="margin-top: 20px"
                   type="button"
                   id="masSubdominios"
                   value="Get more concepts">
            <input type="submit" id="enviarTodo" value="Send">
        </div>
    </form>
    <div class="modal" tabindex="-1" role="dialog" id="loadingModal" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-body">
              <div class="d-flex justify-content-center align-items-center flex-column">
                <p>Loading...</p>
                <img width="50px" height="50px" src="{% static 'images/Loading.gif' %}" alt="Loading...">
              </div>
            </div>
          </div>
        </div>
      </div>
    <p id="resultado"></p>
{% endblock content %}
{% block scripts %}
{{ block.super }}
    <script>
    $(document).ready(function () {
        $('.filter').select2({
            width: '10%',
        });
        
        let valoresSeleccionados = [];
        
        $('.dominio').select2({
            closeOnSelect: true,
            placeholder: 'Domain',
            width: "80%",
            sorter: data => data.sort((a, b) => a.text.localeCompare(b.text)),
            ajax: {
                url: "{% url 'domain:domains' %}",
                delay: 1000,
                data: function (params) {
                    return {
                        'term': params.term,
                        'tipo': $("#filter").val(),
                    };
                },
                processResults: function (data) {
                    var options = [];
                    $.each(data.results, function (index, item) {
                        options.push({
                            id: item.id,
                            text: item.text
                        });
                    });
                    return {
                        results: options
                    };
                }

            }
        });

        $('.dominio').on('change', function (e) {
            var selectedValue = $(this).val();
            console.log("Valor seleccionado:", selectedValue); // Imprimir el valor seleccionado
            var params = {
                selectedValue: selectedValue,
            };
            $.ajax({
                url: '{% url "domain:subdomains" %}',
                data: params,       
                success: function (response) {
                    var select = $('.subdominios');
                    select.empty();
                    var data = JSON.parse(response);

                    // Iterar sobre el objeto data
                    $.each(data, function (index, value) {
                        select.append($('<option></option>').val(value).text(value));
                    });
                    // Establecer los valores seleccionados en función de los valores devueltos por el view
                    select.val(data);
                    select.trigger('change');
                }
            });
        
        });
        
        $('#masSubdominios').click(function (event) {
            event.preventDefault();
            var select = $('.subdominios');
            var nuevosValoresSeleccionados = select.val();
            valoresSeleccionados = valoresSeleccionados.concat(nuevosValoresSeleccionados);
            $('#valores_seleccionados').val(JSON.stringify(valoresSeleccionados));
            var selectedValue = $(".subdominios").val();
            console.log("Valor seleccionado:", selectedValue); // Imprimir el valor seleccionado
            var params = {
                selectedValue: selectedValue,
                level: "1",
            };
            $.ajax({
                url: '{% url "domain:subdomains" %}',
                data: params,
                beforeSend: function() {
                    // Mostrar el modal de carga
                    $("#loadingModal").modal('show');
                },
                success: function (response) {
                    var select = $('.subdominios');
                    select.empty();
                    var data = JSON.parse(response);
                    // Iterar sobre el objeto data
                    $.each(data, function (index, value) {
                        select.append($('<option></option>').val(value).text(value));
                    });
                    // Establecer los valores seleccionados en función de los valores devueltos por el view
                    select.val(data);
                    select.trigger('change');
                },
                complete: function() {
                    // Ocultar el modal de carga
                    $("#loadingModal").modal('hide');
                }
            });
        });

        $('#miFormulario').submit(function (event) {
            event.preventDefault();  // Evitar el envío normal del formulario
            var select = $('.subdominios');
            var nuevosValoresSeleccionados = select.val();
            valoresSeleccionados = valoresSeleccionados.concat(nuevosValoresSeleccionados);
            // Almacenar los valores seleccionados en el campo oculto
            $('#valores_seleccionados').val(JSON.stringify(valoresSeleccionados));
            // Mostrar el modal de carga
            $("#loadingModal").modal('show');
            $(this).unbind('submit').submit();
        });

        $('.subdominios').select2({
            closeOnSelect: false,
            placeholder: 'Select the subdomains',
            width: "100%",
            sorter: data => data.sort((a, b) => a.text.localeCompare(b.text)),
        });

        $('#masSubdominios').click(function () {
            var contador = $('#contador');
            contador.val(parseInt(contador.val()) + 1);
        });
    });
    </script>
{% endblock scripts %}
